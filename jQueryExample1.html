<!DOCTYPE html>
<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!--
 * NOSA HEADER START
 *
 * The contents of this file are subject to the terms of the NASA Open
 * Source Agreement (NOSA), Version 1.3 only (the "Agreement").  You may
 * not use this file except in compliance with the Agreement.
 *
 * You can obtain a copy of the agreement at
 *   docs/NASA_Open_Source_Agreement_1.3.txt
 * or
 *   https://sscweb.gsfc.nasa.gov/WebServices/NASA_Open_Source_Agreement_1.3.txt.
 *
 * See the Agreement for the specific language governing permissions
 * and limitations under the Agreement.
 *
 * When distributing Covered Code, include this NOSA HEADER in each
 * file and include the Agreement file at
 * docs/NASA_Open_Source_Agreement_1.3.txt.  If applicable, add the
 * following below this NOSA HEADER, with the fields enclosed by
 * brackets "[]" replaced with your own identifying information:
 * Portions Copyright [yyyy] [name of copyright owner]
 *
 * NOSA HEADER END
 *
 * Copyright (c) 2012-2017 United States Government as represented by
 * the National Aeronautics and Space Administration. No copyright is
 * claimed in the United States under Title 17, U.S.Code. All Other
 * Rights Reserved.
 *
-->
<title>jQuery Examples of using the SSC Web Services</title>

<!--
<script src="js/jquery-ui-1.8.23.custom.min.js"></script>
<script src="jquery-ui-timepicker-addon.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js">
</script>
-->

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

<script>
var sscUrl='https://sscweb.sci.gsfc.nasa.gov/WS/sscr/2';
                                       // beginning part of URL for the
                                       // SSC web services
var timePattern='(\\d{4})-(\\d{2})-(\\d{2})([T\\s](\\d{2}))?(:(\\d{2}))?(:(\\d{2}))?(\\.(\\d{3}))?Z?';
                                       // regular expression pattern for 
                                       // an ISO 8601 time value
var iso8601RegExp=new RegExp(timePattern);
                                       // regular expression for an ISO 
                                       // 8601 time value

var graphReqXml1 = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?><GraphRequest xmlns="http://sscweb.gsfc.nasa.gov/schema">';
                                       // part 1 of a GraphRequest
var graphReqXml2 = '<BFieldModel><InternalBFieldModel>IGRF-10</InternalBFieldModel><ExternalBFieldModel xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="Tsyganenko89cBFieldModel"><KeyParameterValues>KP3_3_3</KeyParameterValues></ExternalBFieldModel><TraceStopAltitude>100</TraceStopAltitude></BFieldModel>';                                     
                                       // part 2 of a GraphRequest
var graphReqXml3 = '</GraphRequest>';  // part 3 of a GraphRequest

var sats = new Object;                 // satellite descriptions sorted by 
                                       // Name, indexed by Id, and with 
                                       // duplicates (except for different 
                                       // spase resource ids) removed
/**
 * Displays the names of the given observatories for the user to select.
 */
function displayObservatories(observatories) {

  // sort in ascending name order
  observatories.Observatory[1].sort(function(a, b) {
    if (a.Name < b.Name) {
      return -1;
    }
    else if (a.Name > b.Name) {
      return 1;
    }
    return 0;
  });
  // eliminate duplicates, save resulting descriptions in sats, and
  // append an <option> element to <select> element
  var lastName;                        // value of last name encountered
  for (var i = 0; i < observatories.Observatory[1].length; i++) {

    observ = observatories.Observatory[1][i];
    if (lastName != observ.Name) {
      sats[observ.Id] = observ;
      if (observ.Id == 'ace') {

        $("#satSel").append('<option value="' + observ.Id + '" title="' +
                            observ.StartTime + ' to ' + observ.EndTime +
                            '" selected="selected">' + observ.Name +
                            '</option>');
      }
      else {

        $("#satSel").append('<option value="' + observ.Id + '" title="' +
                            observ.StartTime + ' to ' + observ.EndTime +
                            '">' + observ.Name + '</option>');
      }
    }
    lastName = observ.Name;
  }
}

/**
 * Gets <GraphOptions> xml fragment corresponding to the user's selection.
 */
function getGraphOptions() {

  var opt = $('input:radio[name=DISPLAY_TYPE]:checked').val();

  if (opt == 'Orbit') {

    return '<GraphOptions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="OrbitGraphOptions"><CoordinateSystem>Gse</CoordinateSystem><Combined>true</Combined><XyView>true</XyView><XzView>true</XzView><YzView>true</YzView><XrView>true</XrView><SunToRight>false</SunToRight><EvenAxesScale>false</EvenAxesScale><ShowBowShockMagnetopause>true</ShowBowShockMagnetopause><SolarWindPressure>2.1</SolarWindPressure><ImfBz>0.0</ImfBz></GraphOptions>';
  }
  else if (opt == 'Mapped') {

    return '<GraphOptions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="MapProjectionGraphOptions"><Trace>BFieldNorth</Trace><CoordinateSystem>Geo</CoordinateSystem><ShowContinents>true</ShowContinents><Projection>Cylindrical</Projection><GroundStations>FSMI</GroundStations><GroundStations>WHOR</GroundStations><GroundStations>FSIM</GroundStations><GroundStations>GAK</GroundStations><MapLimits><MinLatitude>-90.0</MinLatitude><MaxLatitude>90.0</MaxLatitude><MinLongitude>-180.0</MinLongitude><MaxLongitude>180.0</MaxLongitude></MapLimits><PolarMapOrientation>Equatorial</PolarMapOrientation><LongitudeVerticalDown>0.0</LongitudeVerticalDown><Title>Mapped Plot Test</Title></GraphOptions>';
  }
  else {

    return '<GraphOptions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="TimeSeriesGraphOptions"><CoordinateOptions><CoordinateSystem>Gse</CoordinateSystem><Component>X</Component></CoordinateOptions><CoordinateOptions><CoordinateSystem>Gse</CoordinateSystem><Component>Y</Component></CoordinateOptions><CoordinateOptions><CoordinateSystem>Gse</CoordinateSystem><Component>Z</Component></CoordinateOptions><ValueOptions><RadialDistance>true</RadialDistance><BFieldStrength>true</BFieldStrength><DipoleLValue>true</DipoleLValue><DipoleInvLat>true</DipoleInvLat></ValueOptions><DistanceFromOptions><NeutralSheet>true</NeutralSheet><BowShock>true</BowShock><MPause>true</MPause><BGseXYZ>true</BGseXYZ></DistanceFromOptions><BFieldTraceOptions><CoordinateSystem>Geo</CoordinateSystem><Hemisphere>North</Hemisphere><FootpointLatitude>true</FootpointLatitude><FootpointLongitude>true</FootpointLongitude><FieldLineLength>true</FieldLineLength></BFieldTraceOptions></GraphOptions>';
  }
}

/**
 * Displays the resulting plot.
 */
function displayPlot(result) {

  var urls = $(result).find('Name').map(function () {
                return $(this).text();
            }).get();

  for (var i = 0; i < urls.length; i++) {

    if (urls[i].indexOf('.gif') === urls[i].length - 4) {
// ES6    if (urls[i].endsWith('.gif')) {

      $('#plotImg').attr('src', urls[i]);
    }
    else if (urls[i].indexOf('.pdf') === urls[i].length - 4) {
// ES6  if (urls[i].endsWith('.pdf')) {
//      $('#plotObject').attr('data', urls[i]);
      $('#plotIframe').attr('src', urls[i]);
//      $('#plotEmbed').attr('src', urls[i]);
    }
  }

  $('#notes').slideUp(3000);
}

/**
 * Called if the server returns an error for the requested plot.
 * Displays an alert describing the error to the user.
 */
function plotError(xmlHttpRequest, textStatus, errorThrown) {

  var errDoc = $.parseXML(xmlHttpRequest.responseText); 
  /* errDoc contains xhtml that we might want to display.
     Alternately, just display the Message and Description values. */

  var msg = $(errDoc).find('.ErrorMessage').text();
  var description = $(errDoc).find('.ErrorDescription').text();
  
  alert("Server request error:\n  HTTP error: " + errorThrown + 
        "\n  " + msg + "\n  " + description);
}

/**
 * Gets an ISO 8601 date/time value from the input date/time value.
 */
function getIso8601FromInput(value) {

  var components = iso8601RegExp.exec(value);

  for (var i = 0; i < components.length; i++) {

    if (components[i] === undefined) {

        components[i] = '00';
    }
  }

  return components[1] + '-' + components[2] + '-' + components[3] + 'T' +
         components[5] + ':' + components[7] + ':' + components[9] + '.000Z';
}

/**
 * Gets the corresponding JS Date object for the given ISO 8601 date value.
 */
function getDateFromIso8601(iso8601Date) {
  // Date.parse() does not handle ISO 8601 dates until ECMAScript 5

  var components = iso8601RegExp.exec(iso8601Date);

  for (var i = 0; i < components.length; i++) {

    if (components[i] === undefined) {

        components[i] = 0;
    }
  }

  return new Date(Date.UTC(components[1], components[2] - 1, 
                           components[3], components[5], 
                           components[7], components[9], 
                           components[11]));
}

/**
 * Validates that the given start and end dates are within the range of
 * valid dates for the given satellite.
 */
function validTimeRange(sat, startDate, endDate) {

  var satStartDate = getDateFromIso8601(sat.StartTime);
  var satEndDate = getDateFromIso8601(sat.EndTime);

  if (startDate >= satStartDate && endDate <= satEndDate) {

      return '';
  }
  else {

      return 'Time range outside of data for ' + sat.Name +
              '.\n\nIt must be within ' + sat.StartTime + '\nto ' + 
              sat.EndTime + '.';
  }
}

/**
 * Performs final validation and constructs an XML GraphRequest from the 
 * user's input.  The XML request is used to make a web service request 
 * to SSC to request the data.  The displayPlot function is registered 
 * to handle the results.
 */
function requestData() {

/* the following looses the case of the XML elements
  var req = document.createDocumentFragment();
  var graphReq = req.appendChild(document.createElement("GraphRequest"));
  graphReq.setAttribute("xmlns", "http://sscweb.gsfc.nasa.gov/schema");
  var timeInterval = document.createElement("TimeInterval");
  ...
  so the xml request is created with strings
*/ 

  var selectedSats = $('#satSel option:selected').map(
    function(){ 
      return this.value
    }).get();

  if (selectedSats.length == 0) {

    alert('You must select at least one satellite');
    return;
  }

  // FF 15 is allowing invalid times to get here so we must re-validate 
  var iso8601Start = $('#startTime').val();

  if (!iso8601RegExp.test(iso8601Start)) {

    alert('Invalid Start Time');
    return;
  }
  // make certain that it is a "full" iso 8601 time value
  iso8601Start = getIso8601FromInput(iso8601Start);

  var iso8601End = $('#stopTime').val();

  if (!iso8601RegExp.test(iso8601End)) {

    alert('Invalid Stop Time');
    return;
  }
  iso8601End = getIso8601FromInput(iso8601End);

  var startDate = getDateFromIso8601(iso8601Start);
  var endDate = getDateFromIso8601(iso8601End);

  if (startDate >= endDate) {

    alert('Start Time must be less than Stop Time');
    return;
  }

  var timeReqXml = '<TimeInterval><Start>' + iso8601Start +
    '</Start><End>' + iso8601End + '</End></TimeInterval>';

  var satReqXml = '';
  for (var i = 0; i < selectedSats.length; i++) {

    var satId = selectedSats[i];
    var sat = sats[satId];

    var invalid = validTimeRange(sat, startDate, endDate);

    if (invalid.length > 0) {

        alert(invalid);
        return;
    }
    satReqXml += '<Satellites><Id>' + satId + '</Id>' +
                     '<ResolutionFactor>2</ResolutionFactor></Satellites>';
  }

  var request = graphReqXml1 + timeReqXml + graphReqXml2 + satReqXml + 
                    getGraphOptions() + graphReqXml3;

  $.ajax({
      type: 'POST',
      url: sscUrl + '/graphs', 
      data: request,
      dataType: 'xml',
      contentType: 'application/xml',
      processData: false,
      success: displayPlot, 
      error: plotError
  });

}

/**
 * Called when the browser finished construction the DOM.  It makes an
 * SSC web service call to get the available observatories.  The
 * displayObservatories function is registered to handle the results
 * of web service call.
 */
$(document).ready(function(){
  $.get(sscUrl + '/observatories', displayObservatories, 'json');
});
/*
  $(function() {
    $("#startTime").datetimepicker({
      timeFormat: 'hh:mm:ss z',
      showTimezone: false,
      timezone: '0000'
    });
  });
  $(function() {
    $("#stopTime").datetimepicker({
      timeFormat: 'hh:mm:ss z',
      showTimezone: false,
      timezone: '0000'
    });
  });
*/
</script>

<body>
<h2 style="text-align: center;">
jQuery Examples of using the SSC Web Services
</h2>

<div id="notes" style="border: 1px solid; margin:10px; padding:5px; color: #00529B; background-color: #BDE5F8;">
<p>This page demonstrates using 
<a href="https://jquery.com/" target="_blank">jQuery</a>
<a href="https://api.jquery.com/category/ajax/" target="_blank">.ajax()</a>
to access the 
<a href="https://sscweb.gsfc.nasa.gov/WebServices/REST/" target="_blank">
SSC Web Services</a>.  This page is not intended to be an end-user
application.  It is intended to show web client developers how they could
use the SSC web services in their own 
<a href="https://en.wikipedia.org/wiki/Javascript" target="_blank">JavaScript</a>
 clients.</p>
</div>

<div id="errDialog" title="Server Error Message">
</div>

<form>
<div id="satellites" style="width:25%;padding:10px;border:5px solid blue;margin:10px;float:left;">
  <h4>Satellites</h4>
  <select id="satSel" size="15" multiple="multiple">
  </select>
</div>

<div style="width:25%;float:left;">

<div id="plotType" style="width:100%;padding:10px;border:5px solid blue;margin:10px;">
  <h4>Plot Type</h4>
  <input id="orbitPlotType" type="radio" name="DISPLAY_TYPE" value="Orbit" checked="checked">
  <label for="orbitPlotType">Orbit</label><br>
  <input id="mappedPlotType" type="radio" name="DISPLAY_TYPE" value="Mapped">
  <label for="mappedPlotType">Mapped Projection</label><br>
  <input id="timeSeriesPlotType" type="radio" name="DISPLAY_TYPE" value="Time_Series">
  <label for="timeSeriesPlotType">Time Series</label>
</div>

<div id="time" style="width:100%;padding:10px;border:5px solid blue;margin:10px;">
  <h4>Time</h4>
    <label for="startTime">Start Time</label>
    <input id="startTime" type="text" name="startTime" size="23" 
       value="2012-01-01 00:00:00"
       required="required"
       pattern="\d{4}-\d{2}-\d{2}((( \d{2})?(:\d{2})?)?(:\d{2})?)?"
       title="yyyy-mm-dd[ hh[:mm[:ss]]]"><br>
    <label for="stopTime">Stop Time</label>
    <input id="stopTime" type="text" name="stopTime" size="23" 
       value="2012-01-02 00:00:00"
       required="required"
       pattern="\d{4}-\d{2}-\d{2}((( \d{2})?(:\d{2})?)?(:\d{2})?)?"
       title="yyyy-mm-dd[ hh[:mm[:ss]]]">
</div>

<div id="request" style="clear:both">
<p></p>
  <input id="requestButton" type="button" value="Plot"
     onclick="requestData()">
</div>
</div>
</form>
<br><br>

<div id="plotDiv" style="clear:both">
  <img id="plotImg" alt="Data Plot" src="blank.png">
  <hr>
<!--
  <object id="plotObject" type="application/pdf" height="1000" width="100%">
-->
    <iframe id="plotIframe" style="border: none;" height="1000" width="100%">
      This browser does not support PDFs. Please download the PDF to view it:
    </iframe>
<!--
  </object>
-->
<!--
  <embed id="plotEmbed" alt="Data Plot" width="100%" height="100%" 
       type="application/pdf">
-->
</div>

</body>
</html>
